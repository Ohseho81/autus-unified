<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒŒ AUTUS Physics Map - Complete</title>
  
  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-dark: #0a0a0f;
      --bg-panel: rgba(15, 15, 25, 0.95);
      --border: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #888;
      --accent-cyan: #00ccff;
      --accent-green: #00ff88;
      --accent-gold: #ffcc00;
      --accent-red: #ff4466;
      --accent-purple: #aa66ff;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë©”ì¸ ì»¨í…Œì´ë„ˆ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #app {
      display: flex;
      height: 100vh;
    }
    
    #canvas-container {
      flex: 1;
      position: relative;
      background: radial-gradient(ellipse at center, #0d1117 0%, #000 100%);
    }
    
    #canvas-container svg {
      width: 100%;
      height: 100%;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í—¤ë”
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.95) 0%, transparent 100%);
      padding: 20px 24px;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .header-left h1 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-left h1 .logo {
      font-size: 24px;
    }
    
    .header-left .subtitle {
      color: var(--text-secondary);
      font-size: 10px;
      margin-top: 4px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      margin-top: 8px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-red);
    }
    
    .status-dot.connected {
      background: var(--accent-green);
      box-shadow: 0 0 10px var(--accent-green);
    }
    
    .header-right {
      display: flex;
      gap: 32px;
    }
    
    .stat {
      text-align: right;
    }
    
    .stat-label {
      color: var(--text-secondary);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 700;
      margin-top: 2px;
    }
    
    .stat-value.green { color: var(--accent-green); text-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
    .stat-value.cyan { color: var(--accent-cyan); text-shadow: 0 0 20px rgba(0, 204, 255, 0.5); }
    .stat-value.gold { color: var(--accent-gold); text-shadow: 0 0 20px rgba(255, 204, 0, 0.5); }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       2ë²„íŠ¼ ì‹œìŠ¤í…œ (CUT / LINK)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .action-buttons {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 200;
    }
    
    .action-btn {
      width: 140px;
      height: 60px;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .action-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .btn-cut {
      background: linear-gradient(135deg, #ff4466 0%, #cc2244 100%);
      color: white;
      box-shadow: 0 8px 30px rgba(255, 68, 102, 0.4);
    }
    
    .btn-cut:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(255, 68, 102, 0.6);
    }
    
    .btn-cut:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .btn-link {
      background: linear-gradient(135deg, #00ccff 0%, #0088cc 100%);
      color: white;
      box-shadow: 0 8px 30px rgba(0, 204, 255, 0.4);
    }
    
    .btn-link:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(0, 204, 255, 0.6);
    }
    
    .btn-link:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .selection-hint {
      position: absolute;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 12px;
      color: var(--text-secondary);
      z-index: 200;
    }
    
    .selection-hint .selected-count {
      color: var(--accent-cyan);
      font-weight: 700;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê³µì‹ íŒ¨ë„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .formula-panel {
      position: absolute;
      left: 24px;
      bottom: 140px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .formula-title {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .formula {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent-cyan);
      font-family: 'SF Mono', 'Consolas', monospace;
    }
    
    .formula-desc {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.5;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë…¸ë“œ ìƒì„¸ íŒ¨ë„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .node-detail {
      position: absolute;
      right: 24px;
      top: 100px;
      width: 280px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      z-index: 100;
      backdrop-filter: blur(10px);
      display: none;
    }
    
    .node-detail.visible {
      display: block;
    }
    
    .node-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .node-detail-title {
      font-size: 16px;
      font-weight: 700;
    }
    
    .node-detail-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }
    
    .node-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .node-detail-label {
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .node-detail-value {
      font-weight: 600;
      font-size: 14px;
    }
    
    .node-detail-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    
    .node-detail-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
    }
    
    .node-detail-btn.cut {
      background: rgba(255, 68, 102, 0.2);
      color: var(--accent-red);
      border: 1px solid var(--accent-red);
    }
    
    .node-detail-btn.link {
      background: rgba(0, 204, 255, 0.2);
      color: var(--accent-cyan);
      border: 1px solid var(--accent-cyan);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë¯¸ë‹ˆë§µ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .minimap {
      position: absolute;
      right: 24px;
      bottom: 40px;
      width: 180px;
      height: 120px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      z-index: 100;
      overflow: hidden;
    }
    
    .minimap svg {
      width: 100%;
      height: 100%;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í† ìŠ¤íŠ¸ ì•Œë¦¼
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast-container {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }
    
    .toast.success { border-color: var(--accent-green); }
    .toast.error { border-color: var(--accent-red); }
    .toast.info { border-color: var(--accent-cyan); }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë¡œë”©
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 500;
      transition: opacity 0.5s ease;
    }
    
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid var(--border);
      border-top-color: var(--accent-cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë…¸ë“œ ìŠ¤íƒ€ì¼ (SVG)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .node {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .node:hover {
      filter: brightness(1.2);
    }
    
    .node.selected circle {
      stroke: var(--accent-gold) !important;
      stroke-width: 4px !important;
      stroke-opacity: 1 !important;
    }
    
    .node.selected.link-mode circle {
      stroke: var(--accent-cyan) !important;
    }
    
    .node text {
      fill: white;
      font-size: 11px;
      font-weight: 600;
      text-anchor: middle;
      pointer-events: none;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }
    
    .link {
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 1;
    }
    
    .link.active {
      stroke: var(--accent-cyan);
      stroke-width: 2;
      stroke-dasharray: 5, 5;
      animation: dash 0.5s linear infinite;
    }
    
    @keyframes dash {
      to { stroke-dashoffset: -10; }
    }
    
    /* ê·¸ë¦¬ë“œ */
    .grid-line {
      stroke: rgba(255, 255, 255, 0.03);
      stroke-width: 1;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="canvas-container">
      <!-- ë¡œë”© -->
      <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
      </div>
      
      <!-- í—¤ë” -->
      <div class="header">
        <div class="header-left">
          <h1>
            <span class="logo">ğŸŒŒ</span>
            <span>AUTUS Physics Map</span>
          </h1>
          <div class="subtitle">Zero Meaning Â· Money Physics Â· Flywheel</div>
          <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">ì—°ê²° ì¤‘...</span>
          </div>
        </div>
        
        <div class="header-right">
          <div class="stat">
            <div class="stat-label">Total Value</div>
            <div class="stat-value green" id="totalValue">â‚©0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Synergy</div>
            <div class="stat-value cyan" id="synergy">1.00x</div>
          </div>
          <div class="stat">
            <div class="stat-label">Nodes</div>
            <div class="stat-value gold" id="nodeCount">0</div>
          </div>
        </div>
      </div>
      
      <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
      <div class="toast-container" id="toastContainer"></div>
      
      <!-- ê³µì‹ íŒ¨ë„ -->
      <div class="formula-panel">
        <div class="formula-title">Money Physics Formula</div>
        <div class="formula">V = (M - T) Ã— (1 + s)^t</div>
        <div class="formula-desc">
          V: Value | M: Money In | T: Money Out<br>
          s: Synergy | t: Time
        </div>
      </div>
      
      <!-- ì„ íƒ íŒíŠ¸ -->
      <div class="selection-hint" id="selectionHint" style="display: none;">
        <span class="selected-count" id="selectedCount">0</span>ê°œ ë…¸ë“œ ì„ íƒë¨
        <span id="linkModeHint" style="display: none;"> Â· LINK ëŒ€ìƒ ì„ íƒ</span>
      </div>
      
      <!-- 2ë²„íŠ¼ ì‹œìŠ¤í…œ -->
      <div class="action-buttons">
        <button class="action-btn btn-cut" id="btnCut" disabled>
          <span>âœ‚ï¸</span> CUT
        </button>
        <button class="action-btn btn-link" id="btnLink" disabled>
          <span>ğŸ”—</span> LINK
        </button>
      </div>
      
      <!-- ë…¸ë“œ ìƒì„¸ -->
      <div class="node-detail" id="nodeDetail">
        <div class="node-detail-header">
          <div class="node-detail-title" id="detailTitle">Node</div>
          <button class="node-detail-close" id="detailClose">Ã—</button>
        </div>
        <div class="node-detail-row">
          <span class="node-detail-label">ID</span>
          <span class="node-detail-value" id="detailId">-</span>
        </div>
        <div class="node-detail-row">
          <span class="node-detail-label">Value</span>
          <span class="node-detail-value" id="detailValue">-</span>
        </div>
        <div class="node-detail-row">
          <span class="node-detail-label">Connections</span>
          <span class="node-detail-value" id="detailConnections">-</span>
        </div>
        <div class="node-detail-actions">
          <button class="node-detail-btn cut" id="detailCut">âœ‚ï¸ CUT</button>
          <button class="node-detail-btn link" id="detailLink">ğŸ”— LINK</button>
        </div>
      </div>
      
      <!-- ë¯¸ë‹ˆë§µ -->
      <div class="minimap" id="minimap"></div>
      
      <!-- ë©”ì¸ SVG -->
      <svg id="mainSvg"></svg>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTUS Physics Map - Complete Version
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ì„¤ì •
    const CONFIG = {
      API_URL: 'http://localhost:8000',
      WS_URL: 'ws://localhost:8000/ws/physics-map',
      RECONNECT_INTERVAL: 3000,
      NODE_MIN_RADIUS: 15,
      NODE_MAX_RADIUS: 60,
      LINK_DISTANCE: 150,
      CHARGE_STRENGTH: -400
    };
    
    // ìƒíƒœ
    const state = {
      nodes: [],
      links: [],
      selectedNodes: new Set(),
      linkMode: false,
      linkSource: null,
      totalValue: 0,
      synergy: 1.0,
      connected: false
    };
    
    // DOM ìš”ì†Œ
    const elements = {
      svg: null,
      nodeGroup: null,
      linkGroup: null,
      simulation: null,
      ws: null
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ˆê¸°í™”
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function init() {
      console.log('ğŸŒŒ AUTUS Physics Map ì´ˆê¸°í™”');
      
      setupSVG();
      setupEventListeners();
      
      // ë°ì´í„° ë¡œë“œ ì‹œë„
      try {
        await fetchInitialData();
      } catch (e) {
        console.log('API ì—°ê²° ì‹¤íŒ¨, ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©');
        loadSampleData();
      }
      
      // WebSocket ì—°ê²°
      connectWebSocket();
      
      // ë¡œë”© ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
      }, 500);
      
      render();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SVG ì„¤ì •
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function setupSVG() {
      const container = document.getElementById('canvas-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      elements.svg = d3.select('#mainSvg')
        .attr('width', width)
        .attr('height', height);
      
      // ê·¸ë¦¬ë“œ ë°°ê²½
      const gridSize = 50;
      const gridGroup = elements.svg.append('g').attr('class', 'grid');
      
      for (let x = 0; x < width; x += gridSize) {
        gridGroup.append('line')
          .attr('class', 'grid-line')
          .attr('x1', x).attr('y1', 0)
          .attr('x2', x).attr('y2', height);
      }
      for (let y = 0; y < height; y += gridSize) {
        gridGroup.append('line')
          .attr('class', 'grid-line')
          .attr('x1', 0).attr('y1', y)
          .attr('x2', width).attr('y2', y);
      }
      
      // ë§í¬ ê·¸ë£¹
      elements.linkGroup = elements.svg.append('g').attr('class', 'links');
      
      // ë…¸ë“œ ê·¸ë£¹
      elements.nodeGroup = elements.svg.append('g').attr('class', 'nodes');
      
      // ì‹œë®¬ë ˆì´ì…˜
      elements.simulation = d3.forceSimulation()
        .force('link', d3.forceLink().id(d => d.id).distance(CONFIG.LINK_DISTANCE))
        .force('charge', d3.forceManyBody().strength(CONFIG.CHARGE_STRENGTH))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => getNodeRadius(d) + 10))
        .on('tick', ticked);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function setupEventListeners() {
      // CUT ë²„íŠ¼
      document.getElementById('btnCut').addEventListener('click', handleCut);
      
      // LINK ë²„íŠ¼
      document.getElementById('btnLink').addEventListener('click', handleLink);
      
      // ë…¸ë“œ ìƒì„¸ ë‹«ê¸°
      document.getElementById('detailClose').addEventListener('click', () => {
        document.getElementById('nodeDetail').classList.remove('visible');
      });
      
      // ë…¸ë“œ ìƒì„¸ ì•¡ì…˜
      document.getElementById('detailCut').addEventListener('click', () => {
        const nodeId = document.getElementById('detailId').textContent;
        cutNodes([nodeId]);
        document.getElementById('nodeDetail').classList.remove('visible');
      });
      
      document.getElementById('detailLink').addEventListener('click', () => {
        const nodeId = document.getElementById('detailId').textContent;
        state.linkMode = true;
        state.linkSource = nodeId;
        state.selectedNodes.clear();
        state.selectedNodes.add(nodeId);
        updateSelectionUI();
        showToast('LINK ëŒ€ìƒ ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'info');
      });
      
      // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ
      window.addEventListener('resize', handleResize);
      
      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          cancelSelection();
        }
        if (e.key === 'Delete' || e.key === 'Backspace') {
          if (state.selectedNodes.size > 0) {
            handleCut();
          }
        }
      });
      
      // ë°°ê²½ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
      elements.svg.on('click', (event) => {
        if (event.target.tagName === 'svg' || event.target.classList.contains('grid-line')) {
          cancelSelection();
        }
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë°ì´í„° ë¡œë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function fetchInitialData() {
      const response = await fetch(`${CONFIG.API_URL}/physics/state`);
      if (!response.ok) throw new Error('API Error');
      
      const data = await response.json();
      
      state.nodes = data.nodes || [];
      state.links = data.links || [];
      state.totalValue = data.total_value || 0;
      state.synergy = data.synergy || 1.0;
      
      updateStats();
      showToast('ì„œë²„ ì—°ê²° ì„±ê³µ', 'success');
    }
    
    function loadSampleData() {
      // ìƒ˜í”Œ ë°ì´í„°
      state.nodes = [
        { id: 'P01', name: 'ì˜¤ì„¸í˜¸', value: 50000000 },
        { id: 'P02', name: 'ê¹€ê²½í¬', value: 20000000 },
        { id: 'P03', name: 'ì˜¤ì„ ìš°', value: 35000000 },
        { id: 'P04', name: 'ì˜¤ì—°ìš°', value: -5000000 },
        { id: 'P05', name: 'ì˜¤ì€ìš°', value: 10000000 },
        { id: 'C01', name: 'í•™ì›A', value: 80000000 },
        { id: 'C02', name: 'í•™ì›B', value: 45000000 },
        { id: 'C03', name: 'í•™ì›C', value: -15000000 },
      ];
      
      state.links = [
        { source: 'P01', target: 'C01' },
        { source: 'P01', target: 'C02' },
        { source: 'P02', target: 'C01' },
        { source: 'P03', target: 'C02' },
        { source: 'P03', target: 'C03' },
      ];
      
      calculateStats();
      showToast('ìƒ˜í”Œ ë°ì´í„° ë¡œë“œë¨ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)', 'info');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WebSocket
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function connectWebSocket() {
      try {
        elements.ws = new WebSocket(CONFIG.WS_URL);
        
        elements.ws.onopen = () => {
          console.log('âœ… WebSocket ì—°ê²°ë¨');
          state.connected = true;
          updateConnectionStatus(true);
        };
        
        elements.ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          handleWebSocketMessage(msg);
        };
        
        elements.ws.onclose = () => {
          console.log('âŒ WebSocket ì—°ê²° ëŠê¹€');
          state.connected = false;
          updateConnectionStatus(false);
          
          // ì¬ì—°ê²°
          setTimeout(connectWebSocket, CONFIG.RECONNECT_INTERVAL);
        };
        
        elements.ws.onerror = (err) => {
          console.error('WebSocket ì—ëŸ¬:', err);
        };
      } catch (e) {
        console.log('WebSocket ì—°ê²° ì‹¤íŒ¨');
        updateConnectionStatus(false);
      }
    }
    
    function handleWebSocketMessage(msg) {
      switch (msg.type) {
        case 'node_update':
          handleNodeUpdate(msg.data);
          break;
        case 'motion_update':
          handleMotionUpdate(msg.data);
          break;
        case 'synergy_update':
          handleSynergyUpdate(msg.data);
          break;
        case 'pong':
          // ì—°ê²° ìœ ì§€ í™•ì¸
          break;
        default:
          console.log('Unknown message:', msg);
      }
    }
    
    function handleNodeUpdate(data) {
      const node = state.nodes.find(n => n.id === data.node_id);
      if (node) {
        node.value = data.value;
        pulseNode(data.node_id);
        calculateStats();
        render();
      }
    }
    
    function handleMotionUpdate(data) {
      const { source, target, amount } = data;
      animateFlow(source, target);
    }
    
    function handleSynergyUpdate(data) {
      state.synergy = data.synergy;
      state.totalValue = data.total_value;
      updateStats();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CUT / LINK ì•¡ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function handleCut() {
      if (state.selectedNodes.size === 0) return;
      
      const nodeIds = Array.from(state.selectedNodes);
      await cutNodes(nodeIds);
    }
    
    async function cutNodes(nodeIds) {
      console.log('âœ‚ï¸ CUT:', nodeIds);
      
      // API í˜¸ì¶œ
      if (state.connected) {
        try {
          for (const nodeId of nodeIds) {
            await fetch(`${CONFIG.API_URL}/physics/event`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                event_type: 'burn',
                amount: Math.abs(state.nodes.find(n => n.id === nodeId)?.value || 0),
                participants: [nodeId]
              })
            });
          }
        } catch (e) {
          console.error('CUT API ì—ëŸ¬:', e);
        }
      }
      
      // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      state.nodes = state.nodes.filter(n => !nodeIds.includes(n.id));
      state.links = state.links.filter(l => 
        !nodeIds.includes(l.source.id || l.source) && 
        !nodeIds.includes(l.target.id || l.target)
      );
      
      state.selectedNodes.clear();
      updateSelectionUI();
      calculateStats();
      render();
      
      showToast(`${nodeIds.length}ê°œ ë…¸ë“œ ì‚­ì œë¨`, 'success');
    }
    
    function handleLink() {
      if (state.linkMode && state.linkSource && state.selectedNodes.size > 0) {
        // LINK ì‹¤í–‰
        const targets = Array.from(state.selectedNodes).filter(id => id !== state.linkSource);
        if (targets.length > 0) {
          linkNodes(state.linkSource, targets);
        }
        state.linkMode = false;
        state.linkSource = null;
      } else if (state.selectedNodes.size > 0) {
        // LINK ëª¨ë“œ ì‹œì‘
        const sourceId = Array.from(state.selectedNodes)[0];
        state.linkMode = true;
        state.linkSource = sourceId;
        state.selectedNodes.clear();
        state.selectedNodes.add(sourceId);
        updateSelectionUI();
        showToast('LINK ëŒ€ìƒ ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'info');
      }
    }
    
    async function linkNodes(sourceId, targetIds) {
      console.log('ğŸ”— LINK:', sourceId, '->', targetIds);
      
      // API í˜¸ì¶œ
      if (state.connected) {
        try {
          await fetch(`${CONFIG.API_URL}/physics/drag`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              drag_type: 'link',
              params: { source: sourceId, target: targetIds[0] }
            })
          });
        } catch (e) {
          console.error('LINK API ì—ëŸ¬:', e);
        }
      }
      
      // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      for (const targetId of targetIds) {
        if (!state.links.find(l => 
          (l.source === sourceId || l.source.id === sourceId) && 
          (l.target === targetId || l.target.id === targetId)
        )) {
          state.links.push({ source: sourceId, target: targetId });
        }
      }
      
      state.selectedNodes.clear();
      state.linkMode = false;
      state.linkSource = null;
      updateSelectionUI();
      render();
      
      showToast(`${targetIds.length}ê°œ ë…¸ë“œ ì—°ê²°ë¨`, 'success');
    }
    
    function cancelSelection() {
      state.selectedNodes.clear();
      state.linkMode = false;
      state.linkSource = null;
      updateSelectionUI();
      render();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë Œë”ë§
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function render() {
      // ë§í¬ ë Œë”ë§
      const link = elements.linkGroup.selectAll('.link')
        .data(state.links, d => `${d.source.id || d.source}-${d.target.id || d.target}`);
      
      link.exit().remove();
      
      link.enter()
        .append('line')
        .attr('class', 'link')
        .merge(link);
      
      // ë…¸ë“œ ë Œë”ë§
      const node = elements.nodeGroup.selectAll('.node')
        .data(state.nodes, d => d.id);
      
      node.exit()
        .transition()
        .duration(300)
        .attr('transform', 'scale(0)')
        .remove();
      
      const nodeEnter = node.enter()
        .append('g')
        .attr('class', 'node')
        .call(d3.drag()
          .on('start', dragStarted)
          .on('drag', dragged)
          .on('end', dragEnded)
        )
        .on('click', handleNodeClick)
        .on('dblclick', handleNodeDoubleClick);
      
      nodeEnter.append('circle')
        .attr('r', d => getNodeRadius(d))
        .attr('fill', d => getNodeColor(d))
        .attr('stroke', d => d.value >= 0 ? 'rgba(0, 204, 255, 0.3)' : 'rgba(255, 68, 102, 0.3)')
        .attr('stroke-width', 2);
      
      nodeEnter.append('text')
        .attr('dy', 4)
        .text(d => d.name || d.id);
      
      // ë…¸ë“œ ì—…ë°ì´íŠ¸
      const nodeUpdate = nodeEnter.merge(node);
      
      nodeUpdate.select('circle')
        .attr('r', d => getNodeRadius(d))
        .attr('fill', d => getNodeColor(d));
      
      nodeUpdate.classed('selected', d => state.selectedNodes.has(d.id));
      nodeUpdate.classed('link-mode', state.linkMode);
      
      // ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸
      elements.simulation.nodes(state.nodes);
      elements.simulation.force('link').links(state.links);
      elements.simulation.alpha(0.3).restart();
      
      // ë¯¸ë‹ˆë§µ ì—…ë°ì´íŠ¸
      updateMinimap();
    }
    
    function ticked() {
      elements.linkGroup.selectAll('.link')
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
      
      elements.nodeGroup.selectAll('.node')
        .attr('transform', d => `translate(${d.x}, ${d.y})`);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë…¸ë“œ ìƒí˜¸ì‘ìš©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function handleNodeClick(event, d) {
      event.stopPropagation();
      
      if (state.linkMode) {
        // LINK ëª¨ë“œ: ëŒ€ìƒ ë…¸ë“œ ì„ íƒ
        if (d.id !== state.linkSource) {
          state.selectedNodes.add(d.id);
          updateSelectionUI();
          render();
        }
      } else {
        // ì¼ë°˜ ëª¨ë“œ: í† ê¸€ ì„ íƒ
        if (event.shiftKey || event.ctrlKey || event.metaKey) {
          // ë©€í‹° ì„ íƒ
          if (state.selectedNodes.has(d.id)) {
            state.selectedNodes.delete(d.id);
          } else {
            state.selectedNodes.add(d.id);
          }
        } else {
          // ë‹¨ì¼ ì„ íƒ
          state.selectedNodes.clear();
          state.selectedNodes.add(d.id);
        }
        updateSelectionUI();
        render();
      }
    }
    
    function handleNodeDoubleClick(event, d) {
      event.stopPropagation();
      showNodeDetail(d);
    }
    
    function showNodeDetail(node) {
      document.getElementById('detailTitle').textContent = node.name || node.id;
      document.getElementById('detailId').textContent = node.id;
      document.getElementById('detailValue').textContent = formatCurrency(node.value);
      document.getElementById('detailValue').style.color = node.value >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
      
      const connections = state.links.filter(l => 
        (l.source.id || l.source) === node.id || 
        (l.target.id || l.target) === node.id
      ).length;
      document.getElementById('detailConnections').textContent = connections;
      
      document.getElementById('nodeDetail').classList.add('visible');
    }
    
    // ë“œë˜ê·¸
    function dragStarted(event, d) {
      if (!event.active) elements.simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }
    
    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }
    
    function dragEnded(event, d) {
      if (!event.active) elements.simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI ì—…ë°ì´íŠ¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateSelectionUI() {
      const count = state.selectedNodes.size;
      const hint = document.getElementById('selectionHint');
      const btnCut = document.getElementById('btnCut');
      const btnLink = document.getElementById('btnLink');
      
      if (count > 0) {
        hint.style.display = 'block';
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('linkModeHint').style.display = state.linkMode ? 'inline' : 'none';
        
        btnCut.disabled = state.linkMode;
        btnLink.disabled = false;
        
        if (state.linkMode) {
          btnLink.innerHTML = '<span>âœ…</span> ì—°ê²°';
        } else {
          btnLink.innerHTML = '<span>ğŸ”—</span> LINK';
        }
      } else {
        hint.style.display = 'none';
        btnCut.disabled = true;
        btnLink.disabled = true;
        btnLink.innerHTML = '<span>ğŸ”—</span> LINK';
      }
    }
    
    function updateStats() {
      document.getElementById('totalValue').textContent = formatCurrency(state.totalValue);
      document.getElementById('synergy').textContent = state.synergy.toFixed(2) + 'x';
      document.getElementById('nodeCount').textContent = state.nodes.length;
    }
    
    function calculateStats() {
      state.totalValue = state.nodes.reduce((sum, n) => sum + (n.value || 0), 0);
      const positiveNodes = state.nodes.filter(n => n.value > 0).length;
      state.synergy = positiveNodes > 0 ? Math.pow(positiveNodes, 1.1) : 1;
      updateStats();
    }
    
    function updateConnectionStatus(connected) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      if (connected) {
        dot.classList.add('connected');
        text.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
      }
    }
    
    function updateMinimap() {
      const minimap = d3.select('#minimap');
      minimap.selectAll('*').remove();
      
      const svg = minimap.append('svg');
      const scale = 0.1;
      
      state.nodes.forEach(node => {
        svg.append('circle')
          .attr('cx', (node.x || 500) * scale)
          .attr('cy', (node.y || 300) * scale)
          .attr('r', 3)
          .attr('fill', node.value >= 0 ? 'var(--accent-cyan)' : 'var(--accent-red)');
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì• ë‹ˆë©”ì´ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function pulseNode(nodeId) {
      const node = elements.nodeGroup.selectAll('.node')
        .filter(d => d.id === nodeId);
      
      node.select('circle')
        .transition()
        .duration(200)
        .attr('stroke', 'var(--accent-green)')
        .attr('stroke-width', 6)
        .attr('stroke-opacity', 1)
        .transition()
        .duration(500)
        .attr('stroke-width', 2)
        .attr('stroke-opacity', 0.3);
    }
    
    function animateFlow(sourceId, targetId) {
      const source = state.nodes.find(n => n.id === sourceId);
      const target = state.nodes.find(n => n.id === targetId);
      
      if (!source || !target) return;
      
      const particle = elements.svg.append('circle')
        .attr('cx', source.x)
        .attr('cy', source.y)
        .attr('r', 6)
        .attr('fill', 'var(--accent-green)')
        .attr('opacity', 1);
      
      particle.transition()
        .duration(600)
        .attr('cx', target.x)
        .attr('cy', target.y)
        .attr('opacity', 0)
        .remove();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ìœ í‹¸ë¦¬í‹°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function getNodeRadius(node) {
      const absValue = Math.abs(node.value || 0);
      const minVal = 0;
      const maxVal = 100000000;
      const normalized = Math.min(1, Math.max(0, (absValue - minVal) / (maxVal - minVal)));
      return CONFIG.NODE_MIN_RADIUS + (CONFIG.NODE_MAX_RADIUS - CONFIG.NODE_MIN_RADIUS) * Math.sqrt(normalized);
    }
    
    function getNodeColor(node) {
      if (node.value >= 0) {
        const intensity = Math.min(1, node.value / 50000000);
        return `rgba(0, ${Math.floor(180 + 75 * intensity)}, ${Math.floor(200 + 55 * intensity)}, 0.9)`;
      } else {
        const intensity = Math.min(1, Math.abs(node.value) / 50000000);
        return `rgba(${Math.floor(200 + 55 * intensity)}, ${Math.floor(68 - 30 * intensity)}, ${Math.floor(102 - 50 * intensity)}, 0.9)`;
      }
    }
    
    function formatCurrency(value) {
      const absVal = Math.abs(value);
      let formatted;
      
      if (absVal >= 100000000) {
        formatted = (absVal / 100000000).toFixed(1) + 'ì–µ';
      } else if (absVal >= 10000) {
        formatted = (absVal / 10000).toFixed(0) + 'ë§Œ';
      } else {
        formatted = absVal.toLocaleString();
      }
      
      return (value < 0 ? '-' : '') + 'â‚©' + formatted;
    }
    
    function handleResize() {
      const container = document.getElementById('canvas-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      elements.svg.attr('width', width).attr('height', height);
      elements.simulation.force('center', d3.forceCenter(width / 2, height / 2));
      elements.simulation.alpha(0.3).restart();
    }
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span> ${message}`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // ì£¼ê¸°ì  ping
    setInterval(() => {
      if (elements.ws && elements.ws.readyState === WebSocket.OPEN) {
        elements.ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 30000);
    
    // ì‹œì‘
    init();
  </script>
</body>
</html>
