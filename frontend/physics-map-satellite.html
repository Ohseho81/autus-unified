<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ AUTUS Physics Map - Satellite</title>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- D3.js for animations -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-panel: rgba(10, 10, 20, 0.9);
      --border: rgba(255, 255, 255, 0.15);
      --accent-cyan: #00ccff;
      --accent-green: #00ff88;
      --accent-gold: #ffcc00;
      --accent-red: #ff4466;
      --accent-purple: #aa66ff;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      overflow: hidden;
      color: #fff;
    }
    
    #map {
      width: 100vw;
      height: 100vh;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í—¤ë”
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
      padding: 20px 24px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      pointer-events: none;
    }
    
    .header > * {
      pointer-events: auto;
    }
    
    .header-left h1 {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
    }
    
    .header-left .subtitle {
      color: #888;
      font-size: 11px;
      margin-top: 4px;
      letter-spacing: 2px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      margin-top: 8px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-red);
    }
    
    .status-dot.connected {
      background: var(--accent-green);
      box-shadow: 0 0 10px var(--accent-green);
    }
    
    .header-right {
      display: flex;
      gap: 28px;
    }
    
    .stat {
      text-align: right;
    }
    
    .stat-label {
      color: #666;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }
    
    .green { color: var(--accent-green); }
    .cyan { color: var(--accent-cyan); }
    .gold { color: var(--accent-gold); }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       2ë²„íŠ¼ ì‹œìŠ¤í…œ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .action-buttons {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 1000;
    }
    
    .action-btn {
      width: 130px;
      height: 56px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .btn-cut {
      background: linear-gradient(135deg, #ff4466, #cc2244);
      color: white;
      box-shadow: 0 6px 25px rgba(255, 68, 102, 0.5);
    }
    
    .btn-cut:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 10px 35px rgba(255, 68, 102, 0.7);
    }
    
    .btn-link {
      background: linear-gradient(135deg, #00ccff, #0088cc);
      color: white;
      box-shadow: 0 6px 25px rgba(0, 204, 255, 0.5);
    }
    
    .btn-link:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 10px 35px rgba(0, 204, 255, 0.7);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì •ë³´ íŒ¨ë„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .info-panel {
      position: absolute;
      left: 20px;
      bottom: 120px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      min-width: 200px;
    }
    
    .info-title {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    
    .formula {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-cyan);
      font-family: 'SF Mono', monospace;
      margin-bottom: 8px;
    }
    
    .legend {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      margin: 6px 0;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .legend-line {
      width: 20px;
      height: 3px;
      border-radius: 2px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì„ íƒ íŒíŠ¸
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .selection-hint {
      position: absolute;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 12px;
      color: #888;
      z-index: 1000;
      display: none;
    }
    
    .selection-hint.visible {
      display: block;
    }
    
    .selection-hint .count {
      color: var(--accent-cyan);
      font-weight: 700;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë…¸ë“œ ìƒì„¸ íŒì—…
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .node-popup {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      min-width: 180px;
    }
    
    .node-popup h3 {
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .node-popup .row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 4px 0;
    }
    
    .node-popup .label {
      color: #666;
    }
    
    .node-popup .value {
      font-weight: 600;
    }
    
    .node-popup .value.positive { color: var(--accent-green); }
    .node-popup .value.negative { color: var(--accent-red); }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í† ìŠ¤íŠ¸
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast-container {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
    }
    
    .toast {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 8px;
      font-size: 13px;
      animation: slideIn 0.3s ease;
    }
    
    .toast.success { border-color: var(--accent-green); }
    .toast.error { border-color: var(--accent-red); }
    .toast.info { border-color: var(--accent-cyan); }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ëª¨ì…˜ ë¼ì¸ (SVG Overlay)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .leaflet-overlay-pane svg {
      pointer-events: none;
    }
    
    .motion-line {
      fill: none;
      stroke: var(--accent-gold);
      stroke-width: 3;
      stroke-linecap: round;
      opacity: 0.8;
    }
    
    .motion-line.active {
      stroke-dasharray: 10, 5;
      animation: flowDash 0.5s linear infinite;
    }
    
    @keyframes flowDash {
      to { stroke-dashoffset: -15; }
    }
    
    .motion-particle {
      fill: var(--accent-gold);
      filter: drop-shadow(0 0 6px var(--accent-gold));
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì»¤ìŠ¤í…€ ë§ˆì»¤
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .person-marker {
      background: none;
      border: none;
    }
    
    .marker-inner {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .marker-circle {
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .marker-circle.positive {
      background: linear-gradient(135deg, #00ccff, #0088aa);
      box-shadow: 0 4px 20px rgba(0, 204, 255, 0.5);
    }
    
    .marker-circle.negative {
      background: linear-gradient(135deg, #ff4466, #cc2244);
      box-shadow: 0 4px 20px rgba(255, 68, 102, 0.5);
    }
    
    .marker-circle.selected {
      border-color: var(--accent-gold);
      box-shadow: 0 0 0 4px rgba(255, 204, 0, 0.3), 0 4px 20px rgba(255, 204, 0, 0.5);
    }
    
    .marker-circle:hover {
      transform: scale(1.1);
    }
    
    .marker-label {
      margin-top: 4px;
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      white-space: nowrap;
    }
    
    .marker-value {
      font-size: 9px;
      color: #aaa;
    }
    
    /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
    .marker-circle.pulse::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid var(--accent-green);
      animation: pulseRing 1s ease-out;
    }
    
    @keyframes pulseRing {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
    
    /* Leaflet ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    .leaflet-control-zoom {
      border: none !important;
    }
    
    .leaflet-control-zoom a {
      background: var(--bg-panel) !important;
      color: white !important;
      border: 1px solid var(--border) !important;
    }
  </style>
</head>
<body>
  <!-- ì§€ë„ -->
  <div id="map"></div>
  
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-left">
      <h1>
        <span>ğŸŒ</span>
        <span>AUTUS Physics Map</span>
      </h1>
      <div class="subtitle">SATELLITE Â· MONEY PHYSICS Â· REAL-TIME</div>
      <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">ì—°ê²° ì¤‘...</span>
      </div>
    </div>
    
    <div class="header-right">
      <div class="stat">
        <div class="stat-label">Total Value</div>
        <div class="stat-value green" id="totalValue">â‚©0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Synergy</div>
        <div class="stat-value cyan" id="synergy">1.00x</div>
      </div>
      <div class="stat">
        <div class="stat-label">People</div>
        <div class="stat-value gold" id="nodeCount">0</div>
      </div>
    </div>
  </div>
  
  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- ì •ë³´ íŒ¨ë„ -->
  <div class="info-panel">
    <div class="info-title">Money Physics</div>
    <div class="formula">V = (M - T) Ã— (1 + s)^t</div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background: var(--accent-cyan);"></div>
        <span>ì‚¬ëŒ (ì–‘ìˆ˜ ê°€ì¹˜)</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: var(--accent-red);"></div>
        <span>ì‚¬ëŒ (ìŒìˆ˜ ê°€ì¹˜)</span>
      </div>
      <div class="legend-item">
        <div class="legend-line" style="background: var(--accent-gold);"></div>
        <span>ëˆ íë¦„ (ëª¨ì…˜)</span>
      </div>
    </div>
  </div>
  
  <!-- ì„ íƒ íŒíŠ¸ -->
  <div class="selection-hint" id="selectionHint">
    <span class="count" id="selectedCount">0</span>ëª… ì„ íƒë¨
    <span id="linkModeHint" style="display: none;"> Â· ì—°ê²° ëŒ€ìƒ ì„ íƒ</span>
  </div>
  
  <!-- 2ë²„íŠ¼ -->
  <div class="action-buttons">
    <button class="action-btn btn-cut" id="btnCut" disabled>
      <span>âœ‚ï¸</span> CUT
    </button>
    <button class="action-btn btn-link" id="btnLink" disabled>
      <span>ğŸ”—</span> LINK
    </button>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTUS Physics Map - Satellite Version
    // ë…¸ë“œ = ì‚¬ëŒ, ëª¨ì…˜ = ëˆ íë¦„
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const CONFIG = {
      API_URL: 'http://localhost:8000',
      WS_URL: 'ws://localhost:8000/ws/physics-map',
      DEFAULT_CENTER: [37.5665, 126.9780], // ì„œìš¸
      DEFAULT_ZOOM: 12,
      MIN_MARKER_SIZE: 30,
      MAX_MARKER_SIZE: 80
    };
    
    // ìƒíƒœ
    const state = {
      people: [],      // ë…¸ë“œ = ì‚¬ëŒ
      motions: [],     // ëª¨ì…˜ = ëˆ íë¦„
      selectedIds: new Set(),
      linkMode: false,
      linkSource: null,
      totalValue: 0,
      synergy: 1.0,
      connected: false
    };
    
    // Leaflet ìš”ì†Œ
    let map;
    let markers = {};
    let motionLines = {};
    let svgOverlay;
    let ws;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ˆê¸°í™”
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function init() {
      console.log('ğŸŒ AUTUS Physics Map (Satellite) ì´ˆê¸°í™”');
      
      initMap();
      setupEventListeners();
      loadData();
      connectWebSocket();
    }
    
    function initMap() {
      // Leaflet ì§€ë„ ìƒì„±
      map = L.map('map', {
        center: CONFIG.DEFAULT_CENTER,
        zoom: CONFIG.DEFAULT_ZOOM,
        zoomControl: true
      });
      
      // ìœ„ì„± íƒ€ì¼ (Esri World Imagery)
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri',
        maxZoom: 19
      }).addTo(map);
      
      // ë„ë¡œ/ë¼ë²¨ ì˜¤ë²„ë ˆì´
      L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 19,
        opacity: 0.7
      }).addTo(map);
      
      // SVG ì˜¤ë²„ë ˆì´ (ëª¨ì…˜ ë¼ì¸ìš©)
      svgOverlay = L.svg().addTo(map);
      
      // ì§€ë„ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
      map.on('click', (e) => {
        if (e.originalEvent.target === map._container || 
            e.originalEvent.target.classList.contains('leaflet-tile')) {
          cancelSelection();
        }
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë°ì´í„° ë¡œë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadData() {
      try {
        const response = await fetch(`${CONFIG.API_URL}/physics/state`);
        if (response.ok) {
          const data = await response.json();
          processServerData(data);
          showToast('ì„œë²„ ì—°ê²° ì„±ê³µ', 'success');
        } else {
          throw new Error('API Error');
        }
      } catch (e) {
        console.log('ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©');
        loadSampleData();
      }
      
      renderAll();
    }
    
    function processServerData(data) {
      // ì„œë²„ ë°ì´í„°ë¥¼ ìœ„ì¹˜ ì •ë³´ì™€ í•¨ê»˜ ë³€í™˜
      state.people = (data.nodes || []).map((node, i) => ({
        id: node.id,
        name: node.name || node.id,
        value: node.value || 0,
        lat: node.lat || CONFIG.DEFAULT_CENTER[0] + (Math.random() - 0.5) * 0.05,
        lng: node.lng || CONFIG.DEFAULT_CENTER[1] + (Math.random() - 0.5) * 0.05
      }));
      
      state.motions = (data.links || []).map(link => ({
        source: link.source?.id || link.source,
        target: link.target?.id || link.target,
        amount: link.amount || Math.random() * 10000000
      }));
      
      state.totalValue = data.total_value || 0;
      state.synergy = data.synergy || 1.0;
      updateStats();
    }
    
    function loadSampleData() {
      // ì„œìš¸ ì§€ì—­ ìƒ˜í”Œ ë°ì´í„°
      state.people = [
        { id: 'P01', name: 'ì˜¤ì„¸í˜¸', value: 50000000, lat: 37.5665, lng: 126.9780 },
        { id: 'P02', name: 'ê¹€ê²½í¬', value: 20000000, lat: 37.5700, lng: 126.9850 },
        { id: 'P03', name: 'ì˜¤ì„ ìš°', value: 35000000, lat: 37.5600, lng: 126.9700 },
        { id: 'P04', name: 'ì˜¤ì—°ìš°', value: -5000000, lat: 37.5550, lng: 126.9900 },
        { id: 'P05', name: 'ì˜¤ì€ìš°', value: 10000000, lat: 37.5750, lng: 126.9650 },
        { id: 'P06', name: 'ì´ì² ìˆ˜', value: 45000000, lat: 37.5520, lng: 126.9550 },
        { id: 'P07', name: 'ë°•ì˜í¬', value: -15000000, lat: 37.5800, lng: 126.9950 },
        { id: 'P08', name: 'ìµœë¯¼ìˆ˜', value: 30000000, lat: 37.5450, lng: 126.9800 },
      ];
      
      state.motions = [
        { source: 'P01', target: 'P02', amount: 5000000 },
        { source: 'P01', target: 'P03', amount: 8000000 },
        { source: 'P02', target: 'P06', amount: 3000000 },
        { source: 'P03', target: 'P05', amount: 2000000 },
        { source: 'P06', target: 'P08', amount: 10000000 },
        { source: 'P08', target: 'P04', amount: 1500000 },
      ];
      
      calculateStats();
      showToast('ìƒ˜í”Œ ë°ì´í„° ë¡œë“œë¨ (ì˜¤í”„ë¼ì¸)', 'info');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë Œë”ë§
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderAll() {
      renderMotionLines();
      renderPeople();
      updateStats();
    }
    
    function renderPeople() {
      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};
      
      state.people.forEach(person => {
        const size = getMarkerSize(person.value);
        const isPositive = person.value >= 0;
        const isSelected = state.selectedIds.has(person.id);
        
        // ì»¤ìŠ¤í…€ ì•„ì´ì½˜
        const icon = L.divIcon({
          className: 'person-marker',
          html: `
            <div class="marker-inner">
              <div class="marker-circle ${isPositive ? 'positive' : 'negative'} ${isSelected ? 'selected' : ''}"
                   style="width: ${size}px; height: ${size}px;"
                   data-id="${person.id}">
                ${person.name.charAt(0)}
              </div>
              <div class="marker-label">${person.name}</div>
              <div class="marker-value">${formatCurrency(person.value)}</div>
            </div>
          `,
          iconSize: [size, size + 30],
          iconAnchor: [size / 2, size / 2]
        });
        
        const marker = L.marker([person.lat, person.lng], { icon })
          .addTo(map)
          .on('click', (e) => handleMarkerClick(e, person))
          .on('dblclick', (e) => showPersonPopup(person, e.latlng));
        
        // ë“œë˜ê·¸ ê°€ëŠ¥
        marker.dragging?.enable();
        marker.on('dragend', (e) => {
          const pos = e.target.getLatLng();
          person.lat = pos.lat;
          person.lng = pos.lng;
          renderMotionLines();
        });
        
        markers[person.id] = marker;
      });
    }
    
    function renderMotionLines() {
      // SVG ì„  ê·¸ë¦¬ê¸°
      const svg = d3.select(svgOverlay._container).select('svg');
      svg.selectAll('.motion-group').remove();
      
      const g = svg.append('g').attr('class', 'motion-group');
      
      state.motions.forEach(motion => {
        const source = state.people.find(p => p.id === motion.source);
        const target = state.people.find(p => p.id === motion.target);
        
        if (!source || !target) return;
        
        const sourcePoint = map.latLngToLayerPoint([source.lat, source.lng]);
        const targetPoint = map.latLngToLayerPoint([target.lat, target.lng]);
        
        // ê³¡ì„  ê²½ë¡œ
        const midX = (sourcePoint.x + targetPoint.x) / 2;
        const midY = (sourcePoint.y + targetPoint.y) / 2 - 30;
        
        const path = g.append('path')
          .attr('class', 'motion-line active')
          .attr('d', `M ${sourcePoint.x} ${sourcePoint.y} Q ${midX} ${midY} ${targetPoint.x} ${targetPoint.y}`)
          .attr('stroke-width', Math.max(2, Math.min(6, motion.amount / 2000000)));
        
        // ëˆ íë¦„ íŒŒí‹°í´ ì• ë‹ˆë©”ì´ì…˜
        animateMoneyFlow(g, sourcePoint, targetPoint, midX, midY);
      });
      
      // ë·° ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸
      map.on('moveend zoomend', () => {
        renderMotionLines();
      });
    }
    
    function animateMoneyFlow(g, source, target, midX, midY) {
      const particle = g.append('circle')
        .attr('class', 'motion-particle')
        .attr('r', 5)
        .attr('cx', source.x)
        .attr('cy', source.y);
      
      function animate() {
        particle
          .attr('cx', source.x)
          .attr('cy', source.y)
          .transition()
          .duration(2000)
          .ease(d3.easeLinear)
          .attrTween('cx', () => {
            return (t) => {
              const x1 = source.x + (midX - source.x) * t * 2;
              const x2 = midX + (target.x - midX) * (t * 2 - 1);
              return t < 0.5 ? x1 : x2;
            };
          })
          .attrTween('cy', () => {
            return (t) => {
              const y1 = source.y + (midY - source.y) * t * 2;
              const y2 = midY + (target.y - midY) * (t * 2 - 1);
              return t < 0.5 ? y1 : y2;
            };
          })
          .on('end', animate);
      }
      
      animate();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function setupEventListeners() {
      document.getElementById('btnCut').addEventListener('click', handleCut);
      document.getElementById('btnLink').addEventListener('click', handleLink);
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') cancelSelection();
        if ((e.key === 'Delete' || e.key === 'Backspace') && state.selectedIds.size > 0) {
          handleCut();
        }
      });
    }
    
    function handleMarkerClick(e, person) {
      L.DomEvent.stopPropagation(e);
      
      if (state.linkMode) {
        if (person.id !== state.linkSource) {
          state.selectedIds.add(person.id);
          updateSelectionUI();
          renderPeople();
        }
      } else {
        if (e.originalEvent.shiftKey || e.originalEvent.ctrlKey || e.originalEvent.metaKey) {
          if (state.selectedIds.has(person.id)) {
            state.selectedIds.delete(person.id);
          } else {
            state.selectedIds.add(person.id);
          }
        } else {
          state.selectedIds.clear();
          state.selectedIds.add(person.id);
        }
        updateSelectionUI();
        renderPeople();
      }
    }
    
    function showPersonPopup(person, latlng) {
      const popup = L.popup({
        className: 'node-popup-container',
        closeButton: true
      })
        .setLatLng(latlng)
        .setContent(`
          <div class="node-popup">
            <h3>ğŸ‘¤ ${person.name}</h3>
            <div class="row">
              <span class="label">ID</span>
              <span class="value">${person.id}</span>
            </div>
            <div class="row">
              <span class="label">ê°€ì¹˜</span>
              <span class="value ${person.value >= 0 ? 'positive' : 'negative'}">
                ${formatCurrency(person.value)}
              </span>
            </div>
            <div class="row">
              <span class="label">ìœ„ì¹˜</span>
              <span class="value">${person.lat.toFixed(4)}, ${person.lng.toFixed(4)}</span>
            </div>
          </div>
        `)
        .openOn(map);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CUT / LINK ì•¡ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function handleCut() {
      if (state.selectedIds.size === 0) return;
      
      const ids = Array.from(state.selectedIds);
      console.log('âœ‚ï¸ CUT:', ids);
      
      // API í˜¸ì¶œ
      if (state.connected) {
        try {
          for (const id of ids) {
            await fetch(`${CONFIG.API_URL}/physics/event`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                event_type: 'burn',
                amount: Math.abs(state.people.find(p => p.id === id)?.value || 0),
                participants: [id]
              })
            });
          }
        } catch (e) {
          console.error('CUT API ì—ëŸ¬:', e);
        }
      }
      
      // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      state.people = state.people.filter(p => !ids.includes(p.id));
      state.motions = state.motions.filter(m => 
        !ids.includes(m.source) && !ids.includes(m.target)
      );
      
      state.selectedIds.clear();
      updateSelectionUI();
      calculateStats();
      renderAll();
      
      showToast(`${ids.length}ëª… ì‚­ì œë¨`, 'success');
    }
    
    function handleLink() {
      if (state.linkMode && state.linkSource && state.selectedIds.size > 0) {
        const targets = Array.from(state.selectedIds).filter(id => id !== state.linkSource);
        if (targets.length > 0) {
          linkPeople(state.linkSource, targets);
        }
        state.linkMode = false;
        state.linkSource = null;
      } else if (state.selectedIds.size > 0) {
        const sourceId = Array.from(state.selectedIds)[0];
        state.linkMode = true;
        state.linkSource = sourceId;
        state.selectedIds.clear();
        state.selectedIds.add(sourceId);
        updateSelectionUI();
        renderPeople();
        showToast('ì—°ê²°í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”', 'info');
      }
    }
    
    async function linkPeople(sourceId, targetIds) {
      console.log('ğŸ”— LINK:', sourceId, '->', targetIds);
      
      if (state.connected) {
        try {
          await fetch(`${CONFIG.API_URL}/physics/drag`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              drag_type: 'link',
              params: { source: sourceId, target: targetIds[0] }
            })
          });
        } catch (e) {
          console.error('LINK API ì—ëŸ¬:', e);
        }
      }
      
      // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      for (const targetId of targetIds) {
        if (!state.motions.find(m => m.source === sourceId && m.target === targetId)) {
          state.motions.push({
            source: sourceId,
            target: targetId,
            amount: Math.random() * 5000000 + 1000000
          });
        }
      }
      
      state.selectedIds.clear();
      state.linkMode = false;
      state.linkSource = null;
      updateSelectionUI();
      renderAll();
      
      showToast(`${targetIds.length}ê°œ ì—°ê²° ìƒì„±ë¨`, 'success');
    }
    
    function cancelSelection() {
      state.selectedIds.clear();
      state.linkMode = false;
      state.linkSource = null;
      updateSelectionUI();
      renderPeople();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WebSocket
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function connectWebSocket() {
      try {
        ws = new WebSocket(CONFIG.WS_URL);
        
        ws.onopen = () => {
          state.connected = true;
          updateConnectionStatus(true);
          console.log('âœ… WebSocket ì—°ê²°ë¨');
        };
        
        ws.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          handleWSMessage(msg);
        };
        
        ws.onclose = () => {
          state.connected = false;
          updateConnectionStatus(false);
          setTimeout(connectWebSocket, 3000);
        };
        
        ws.onerror = () => {
          updateConnectionStatus(false);
        };
      } catch (e) {
        updateConnectionStatus(false);
      }
    }
    
    function handleWSMessage(msg) {
      if (msg.type === 'node_update') {
        const person = state.people.find(p => p.id === msg.data.node_id);
        if (person) {
          person.value = msg.data.value;
          pulseMarker(msg.data.node_id);
          calculateStats();
          renderPeople();
        }
      } else if (msg.type === 'motion_update') {
        animateNewMotion(msg.data.source, msg.data.target);
      }
    }
    
    function pulseMarker(id) {
      const marker = markers[id];
      if (marker) {
        const el = marker.getElement()?.querySelector('.marker-circle');
        if (el) {
          el.classList.add('pulse');
          setTimeout(() => el.classList.remove('pulse'), 1000);
        }
      }
    }
    
    function animateNewMotion(sourceId, targetId) {
      const source = state.people.find(p => p.id === sourceId);
      const target = state.people.find(p => p.id === targetId);
      
      if (!source || !target) return;
      
      // í° íŒŒí‹°í´ ì• ë‹ˆë©”ì´ì…˜
      const svg = d3.select(svgOverlay._container).select('svg');
      const sp = map.latLngToLayerPoint([source.lat, source.lng]);
      const tp = map.latLngToLayerPoint([target.lat, target.lng]);
      
      svg.append('circle')
        .attr('cx', sp.x)
        .attr('cy', sp.y)
        .attr('r', 10)
        .attr('fill', 'var(--accent-green)')
        .attr('filter', 'drop-shadow(0 0 10px var(--accent-green))')
        .transition()
        .duration(800)
        .attr('cx', tp.x)
        .attr('cy', tp.y)
        .attr('r', 0)
        .remove();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI ì—…ë°ì´íŠ¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateSelectionUI() {
      const count = state.selectedIds.size;
      const hint = document.getElementById('selectionHint');
      const btnCut = document.getElementById('btnCut');
      const btnLink = document.getElementById('btnLink');
      
      if (count > 0) {
        hint.classList.add('visible');
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('linkModeHint').style.display = state.linkMode ? 'inline' : 'none';
        
        btnCut.disabled = state.linkMode;
        btnLink.disabled = false;
        
        btnLink.innerHTML = state.linkMode 
          ? '<span>âœ…</span> ì—°ê²°' 
          : '<span>ğŸ”—</span> LINK';
      } else {
        hint.classList.remove('visible');
        btnCut.disabled = true;
        btnLink.disabled = true;
        btnLink.innerHTML = '<span>ğŸ”—</span> LINK';
      }
    }
    
    function updateStats() {
      document.getElementById('totalValue').textContent = formatCurrency(state.totalValue);
      document.getElementById('synergy').textContent = state.synergy.toFixed(2) + 'x';
      document.getElementById('nodeCount').textContent = state.people.length;
    }
    
    function calculateStats() {
      state.totalValue = state.people.reduce((sum, p) => sum + p.value, 0);
      const positive = state.people.filter(p => p.value > 0).length;
      state.synergy = positive > 0 ? Math.pow(positive, 1.1) : 1;
      updateStats();
    }
    
    function updateConnectionStatus(connected) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      if (connected) {
        dot.classList.add('connected');
        text.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ìœ í‹¸ë¦¬í‹°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function getMarkerSize(value) {
      const absVal = Math.abs(value);
      const normalized = Math.min(1, absVal / 50000000);
      return CONFIG.MIN_MARKER_SIZE + (CONFIG.MAX_MARKER_SIZE - CONFIG.MIN_MARKER_SIZE) * Math.sqrt(normalized);
    }
    
    function formatCurrency(value) {
      const abs = Math.abs(value);
      let str;
      if (abs >= 100000000) str = (abs / 100000000).toFixed(1) + 'ì–µ';
      else if (abs >= 10000) str = (abs / 10000).toFixed(0) + 'ë§Œ';
      else str = abs.toLocaleString();
      return (value < 0 ? '-' : '') + 'â‚©' + str;
    }
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${message}`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Ping
    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 30000);
    
    // ì‹œì‘
    init();
  </script>
</body>
</html>
