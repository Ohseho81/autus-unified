<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AUTUS Physics Map - Live</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0a0a0f;
      --card: rgba(18, 18, 26, 0.95);
      --border: #1e1e2e;
      --text: #e0e0e0;
      --dim: #888;
      --accent: #00d4aa;
      --warning: #ffd700;
      --danger: #ff6b6b;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    header {
      padding: 15px 20px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon { font-size: 1.5rem; }
    .logo-text { font-weight: 700; font-size: 1.2rem; }
    
    .status-bar {
      display: flex;
      gap: 20px;
      font-size: 0.85rem;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
    }
    
    .status-dot.offline { background: var(--danger); }
    
    /* Main Layout */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: 350px;
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .sidebar-title {
      font-weight: 700;
      margin-bottom: 15px;
    }
    
    /* 3 Buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .action-btn {
      padding: 15px 10px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .action-btn:hover { transform: translateY(-2px); }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .action-btn.cut { border-color: var(--danger); }
    .action-btn.cut:hover { background: rgba(255,107,107,0.2); }
    
    .action-btn.link { border-color: var(--accent); }
    .action-btn.link:hover { background: rgba(0,212,170,0.2); }
    
    .action-btn.outsource { border-color: var(--warning); }
    .action-btn.outsource:hover { background: rgba(255,215,0,0.2); }
    
    .btn-icon { font-size: 1.5rem; margin-bottom: 5px; }
    .btn-label { font-size: 0.8rem; font-weight: 600; }
    
    /* Stats */
    .stats-section {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .stat-card {
      background: var(--bg);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--dim);
      margin-top: 5px;
    }
    
    /* Node List */
    .node-list-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .node-list-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .node-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .node-item {
      background: var(--bg);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--border);
    }
    
    .node-item:hover {
      border-color: var(--accent);
    }
    
    .node-item.selected {
      border-color: var(--accent);
      background: rgba(0,212,170,0.1);
    }
    
    .node-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .node-id {
      font-weight: 700;
      color: var(--accent);
    }
    
    .node-value {
      font-weight: 600;
    }
    
    .node-details {
      font-size: 0.8rem;
      color: var(--dim);
    }
    
    /* Map */
    .map-container {
      flex: 1;
      position: relative;
    }
    
    #map {
      width: 100%;
      height: 100%;
      background: #1a1a2e;
    }
    
    /* Node Info Panel */
    .info-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 300px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      display: none;
    }
    
    .info-panel.show { display: block; }
    
    .info-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-close {
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--dim);
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .info-label { color: var(--dim); }
    .info-value { font-weight: 600; }
    
    .info-actions {
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .info-btn {
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .info-btn.danger { background: var(--danger); color: #fff; }
    .info-btn.primary { background: var(--accent); color: #000; }
    .info-btn.warning { background: var(--warning); color: #000; }
    
    /* Add Node Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show { display: flex; }
    
    .modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 30px;
      width: 400px;
      max-width: 90%;
    }
    
    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
      color: var(--dim);
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .modal-btn.cancel { background: var(--border); color: var(--text); }
    .modal-btn.submit { background: var(--accent); color: #000; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 15px 25px;
      display: none;
      z-index: 1001;
    }
    
    .toast.show { display: block; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span class="logo-icon">üåê</span>
      <span class="logo-text">AUTUS Physics Map</span>
    </div>
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot" id="apiStatus"></span>
        <span id="apiStatusText">Connecting...</span>
      </div>
      <div class="status-item">
        <span>LLM: 0 calls</span>
      </div>
      <div class="status-item">
        <span>Zero Meaning: ‚úì</span>
      </div>
    </div>
  </header>
  
  <div class="main-container">
    <aside class="sidebar">
      <!-- 3 Buttons -->
      <div class="sidebar-header">
        <div class="sidebar-title">üéÆ Actions</div>
        <div class="action-buttons">
          <button class="action-btn cut" id="btnCut" disabled>
            <div class="btn-icon">‚úÇÔ∏è</div>
            <div class="btn-label">CUT</div>
          </button>
          <button class="action-btn link" id="btnLink">
            <div class="btn-icon">üîó</div>
            <div class="btn-label">LINK</div>
          </button>
          <button class="action-btn outsource" id="btnOutsource" disabled>
            <div class="btn-icon">üì§</div>
            <div class="btn-label">OUTSOURCE</div>
          </button>
        </div>
      </div>
      
      <!-- Stats -->
      <div class="stats-section">
        <div class="sidebar-title">üìä Statistics</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statNodes">0</div>
            <div class="stat-label">Nodes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statMotions">0</div>
            <div class="stat-label">Motions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statValue">‚Ç©0</div>
            <div class="stat-label">Total Value</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statFlow">‚Ç©0</div>
            <div class="stat-label">Total Flow</div>
          </div>
        </div>
      </div>
      
      <!-- Node List -->
      <div class="node-list-section">
        <div class="node-list-header">
          <span>üìç Nodes</span>
          <button class="action-btn link" style="padding: 8px 15px;" onclick="showAddNodeModal()">+ Add</button>
        </div>
        <div class="node-list" id="nodeList">
          <!-- Dynamic -->
        </div>
      </div>
    </aside>
    
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Info Panel -->
      <div class="info-panel" id="infoPanel">
        <div class="info-title">
          <span>Node <span id="infoNodeId">-</span></span>
          <span class="info-close" onclick="hideInfoPanel()">√ó</span>
        </div>
        <div class="info-row">
          <span class="info-label">Value</span>
          <span class="info-value" id="infoValue">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Direct Money</span>
          <span class="info-value" id="infoDirectMoney">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Time Cost</span>
          <span class="info-value" id="infoTimeCost">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Synergy</span>
          <span class="info-value" id="infoSynergy">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Location</span>
          <span class="info-value" id="infoLocation">-</span>
        </div>
        <div class="info-actions">
          <button class="info-btn danger" onclick="cutNode()">CUT</button>
          <button class="info-btn primary" onclick="recalculateNode()">Calculate</button>
          <button class="info-btn warning" onclick="outsourceNode()">OUTSOURCE</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Node Modal -->
  <div class="modal" id="addNodeModal">
    <div class="modal-content">
      <div class="modal-title">‚ûï Add Node</div>
      <div class="form-group">
        <label class="form-label">Latitude</label>
        <input type="number" class="form-input" id="inputLat" placeholder="37.5665" step="0.0001">
      </div>
      <div class="form-group">
        <label class="form-label">Longitude</label>
        <input type="number" class="form-input" id="inputLon" placeholder="126.9780" step="0.0001">
      </div>
      <div class="form-group">
        <label class="form-label">Initial Value (‚Ç©)</label>
        <input type="number" class="form-input" id="inputValue" placeholder="1000000">
      </div>
      <div class="form-group">
        <label class="form-label">Time Cost (‚Ç©)</label>
        <input type="number" class="form-input" id="inputTimeCost" placeholder="0">
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideAddNodeModal()">Cancel</button>
        <button class="modal-btn submit" onclick="createNode()">Create Node</button>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    const API_URL = 'http://localhost:3000/api';
    let map;
    let markers = {};
    let selectedNodeId = null;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      checkAPIStatus();
      loadData();
      
      // Î≤ÑÌäº Ïù¥Î≤§Ìä∏
      document.getElementById('btnCut').addEventListener('click', cutNode);
      document.getElementById('btnLink').addEventListener('click', showLinkModal);
      document.getElementById('btnOutsource').addEventListener('click', outsourceNode);
    });
    
    function initMap() {
      map = L.map('map', {
        center: [37.5665, 126.9780],
        zoom: 7,
        zoomControl: true
      });
      
      // Dark tile layer
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap, ¬© CARTO'
      }).addTo(map);
      
      // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïãú ÎÖ∏Îìú Ï∂îÍ∞Ä
      map.on('click', (e) => {
        document.getElementById('inputLat').value = e.latlng.lat.toFixed(4);
        document.getElementById('inputLon').value = e.latlng.lng.toFixed(4);
        showAddNodeModal();
      });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // API
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function checkAPIStatus() {
      try {
        const res = await fetch(API_URL.replace('/api', '/'));
        if (res.ok) {
          document.getElementById('apiStatus').classList.remove('offline');
          document.getElementById('apiStatusText').textContent = 'API Online';
        }
      } catch (e) {
        document.getElementById('apiStatus').classList.add('offline');
        document.getElementById('apiStatusText').textContent = 'API Offline';
      }
    }
    
    async function loadData() {
      try {
        // Load nodes
        const nodesRes = await fetch(`${API_URL}/nodes`);
        const nodesData = await nodesRes.json();
        
        // Load motions
        const motionsRes = await fetch(`${API_URL}/motions`);
        const motionsData = await motionsRes.json();
        
        // Load stats
        const statsRes = await fetch(`${API_URL}/stats`);
        const statsData = await statsRes.json();
        
        // Update UI
        updateNodeList(nodesData.nodes);
        updateMarkers(nodesData.nodes);
        updateStats(statsData);
        
      } catch (e) {
        console.error('Failed to load data:', e);
        showToast('API connection failed. Using demo mode.');
        loadDemoData();
      }
    }
    
    function loadDemoData() {
      const demoNodes = [
        { id: 1, lat: 37.5665, lon: 126.9780, value: 5000000, direct_money: 5000000, time_cost: 500000, synergy_money: 500000 },
        { id: 2, lat: 36.3504, lon: 127.3845, value: 3000000, direct_money: 3000000, time_cost: 300000, synergy_money: 300000 },
        { id: 3, lat: 35.1796, lon: 129.0756, value: 4000000, direct_money: 4000000, time_cost: 400000, synergy_money: 400000 }
      ];
      
      updateNodeList(demoNodes);
      updateMarkers(demoNodes);
      updateStats({
        nodes_count: 3,
        motions_count: 2,
        total_value: 12000000,
        total_flow: 2000000
      });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI UPDATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function updateNodeList(nodes) {
      const list = document.getElementById('nodeList');
      list.innerHTML = '';
      
      nodes.forEach(node => {
        const item = document.createElement('div');
        item.className = 'node-item';
        item.dataset.id = node.id;
        item.onclick = () => selectNode(node.id);
        
        item.innerHTML = `
          <div class="node-header">
            <span class="node-id">N-${String(node.id).padStart(3, '0')}</span>
            <span class="node-value">‚Ç©${formatNumber(node.value)}</span>
          </div>
          <div class="node-details">
            ${node.lat.toFixed(4)}, ${node.lon.toFixed(4)}
          </div>
        `;
        
        list.appendChild(item);
      });
    }
    
    function updateMarkers(nodes) {
      // Clear existing markers
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};
      
      nodes.forEach(node => {
        const size = Math.max(10, Math.min(50, node.value / 200000));
        
        const marker = L.circleMarker([node.lat, node.lon], {
          radius: size,
          fillColor: '#00d4aa',
          fillOpacity: 0.7,
          color: '#00d4aa',
          weight: 2
        }).addTo(map);
        
        marker.on('click', () => selectNode(node.id));
        markers[node.id] = marker;
      });
    }
    
    function updateStats(stats) {
      document.getElementById('statNodes').textContent = stats.nodes_count || 0;
      document.getElementById('statMotions').textContent = stats.motions_count || 0;
      document.getElementById('statValue').textContent = '‚Ç©' + formatNumber(stats.total_value || 0);
      document.getElementById('statFlow').textContent = '‚Ç©' + formatNumber(stats.total_flow || 0);
    }
    
    function selectNode(id) {
      selectedNodeId = id;
      
      // Update UI
      document.querySelectorAll('.node-item').forEach(item => {
        item.classList.toggle('selected', parseInt(item.dataset.id) === id);
      });
      
      // Enable buttons
      document.getElementById('btnCut').disabled = false;
      document.getElementById('btnOutsource').disabled = false;
      
      // Update marker
      Object.entries(markers).forEach(([nodeId, marker]) => {
        if (parseInt(nodeId) === id) {
          marker.setStyle({ color: '#ffd700', fillColor: '#ffd700' });
        } else {
          marker.setStyle({ color: '#00d4aa', fillColor: '#00d4aa' });
        }
      });
      
      // Show info panel
      showInfoPanel(id);
    }
    
    async function showInfoPanel(id) {
      try {
        const res = await fetch(`${API_URL}/nodes/${id}`);
        const node = await res.json();
        
        document.getElementById('infoNodeId').textContent = `N-${String(id).padStart(3, '0')}`;
        document.getElementById('infoValue').textContent = '‚Ç©' + formatNumber(node.value);
        document.getElementById('infoDirectMoney').textContent = '‚Ç©' + formatNumber(node.direct_money || 0);
        document.getElementById('infoTimeCost').textContent = '‚Ç©' + formatNumber(node.time_cost || 0);
        document.getElementById('infoSynergy').textContent = '‚Ç©' + formatNumber(node.synergy_money || 0);
        document.getElementById('infoLocation').textContent = `${node.lat.toFixed(4)}, ${node.lon.toFixed(4)}`;
        
        document.getElementById('infoPanel').classList.add('show');
      } catch (e) {
        console.error('Failed to load node info');
      }
    }
    
    function hideInfoPanel() {
      document.getElementById('infoPanel').classList.remove('show');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function createNode() {
      const lat = parseFloat(document.getElementById('inputLat').value);
      const lon = parseFloat(document.getElementById('inputLon').value);
      const value = parseFloat(document.getElementById('inputValue').value) || 0;
      const time_cost = parseFloat(document.getElementById('inputTimeCost').value) || 0;
      
      if (!lat || !lon) {
        showToast('Latitude and Longitude required');
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/nodes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, value, time_cost })
        });
        
        const data = await res.json();
        showToast(`Node N-${String(data.node.id).padStart(3, '0')} created!`);
        hideAddNodeModal();
        loadData();
      } catch (e) {
        showToast('Failed to create node');
      }
    }
    
    async function cutNode() {
      if (!selectedNodeId) return;
      
      if (!confirm(`Delete Node N-${String(selectedNodeId).padStart(3, '0')}?`)) return;
      
      try {
        const res = await fetch(`${API_URL}/actions/cut`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ node_id: selectedNodeId })
        });
        
        const data = await res.json();
        showToast(`CUT executed: ${data.effect}`);
        hideInfoPanel();
        selectedNodeId = null;
        loadData();
      } catch (e) {
        showToast('CUT failed');
      }
    }
    
    function showLinkModal() {
      const source = prompt('Source Node ID:');
      const target = prompt('Target Node ID:');
      const amount = prompt('Amount (‚Ç©):');
      
      if (source && target) {
        createLink(parseInt(source), parseInt(target), parseFloat(amount) || 0);
      }
    }
    
    async function createLink(source, target, amount) {
      try {
        const res = await fetch(`${API_URL}/actions/link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source_id: source, target_id: target, amount })
        });
        
        const data = await res.json();
        showToast(`LINK created! Synergy: ${data.effect.synergy_created}`);
        loadData();
      } catch (e) {
        showToast('LINK failed');
      }
    }
    
    async function outsourceNode() {
      if (!selectedNodeId) return;
      
      try {
        const res = await fetch(`${API_URL}/actions/outsource`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ node_id: selectedNodeId, external_rate: 0.3 })
        });
        
        const data = await res.json();
        showToast(`OUTSOURCE: Time cost reduced by ‚Ç©${formatNumber(data.effect.time_cost_reduced)}`);
        loadData();
        showInfoPanel(selectedNodeId);
      } catch (e) {
        showToast('OUTSOURCE failed');
      }
    }
    
    async function recalculateNode() {
      if (!selectedNodeId) return;
      
      try {
        const res = await fetch(`${API_URL}/nodes/${selectedNodeId}/calculate`, {
          method: 'POST'
        });
        
        const data = await res.json();
        showToast(`Recalculated: V = ‚Ç©${formatNumber(data.value)}`);
        loadData();
        showInfoPanel(selectedNodeId);
      } catch (e) {
        showToast('Calculation failed');
      }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODALS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function showAddNodeModal() {
      document.getElementById('addNodeModal').classList.add('show');
    }
    
    function hideAddNodeModal() {
      document.getElementById('addNodeModal').classList.remove('show');
      document.getElementById('inputLat').value = '';
      document.getElementById('inputLon').value = '';
      document.getElementById('inputValue').value = '';
      document.getElementById('inputTimeCost').value = '';
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function formatNumber(num) {
      return new Intl.NumberFormat('ko-KR').format(Math.round(num));
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    console.log('üöÄ AUTUS Physics Map - 100% Free Open Source | LLM Minimized');
  </script>
</body>
</html>
