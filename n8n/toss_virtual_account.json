{
  "name": "AUTUS í† ìŠ¤ ê°€ìƒê³„ì¢Œ (ìˆ˜ìˆ˜ë£Œ 0%)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "toss-virtual-account",
        "responseMode": "responseNode"
      },
      "id": "toss_webhook",
      "name": "í† ìŠ¤ ì…ê¸ˆ Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// í† ìŠ¤ ê°€ìƒê³„ì¢Œ ì…ê¸ˆ í™•ì¸\nconst data = $input.item.json.body;\n\n// ì…ê¸ˆ ì™„ë£Œ í™•ì¸\nif (data.status !== 'DONE') {\n  return [{ json: { skip: true, reason: 'Not completed' } }];\n}\n\n// Zero Meaning ì •ì œ\nconst orderId = data.orderId || '';\nconst customerId = orderId.includes('_') ? orderId.split('_')[0] : orderId;\n\nconst cleaned = {\n  node_id: customerId,\n  value: parseFloat(data.totalAmount || 0),\n  method: 'virtual_account',\n  fee: 0,  // ìˆ˜ìˆ˜ë£Œ 0%!\n  fee_saved: parseFloat(data.totalAmount || 0) * 0.03,  // ì¹´ë“œ ëŒ€ë¹„ ì ˆì•½\n  source: 'toss_va',\n  timestamp: data.approvedAt || new Date().toISOString()\n};\n\nreturn [{ json: cleaned }];"
      },
      "id": "toss_parser",
      "name": "í† ìŠ¤ íŒŒì‹± (ìˆ˜ìˆ˜ë£Œ 0%)",
      "type": "n8n-nodes-base.function",
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            { "value1": "={{ $json.skip }}", "value2": true }
          ]
        }
      },
      "id": "skip_check",
      "name": "ì™„ë£Œ ì²´í¬",
      "type": "n8n-nodes-base.if",
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: 'toss_va' }) }}"
      },
      "id": "create_node",
      "name": "ë…¸ë“œ ìƒì„±",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.node_id, target_id: 'owner', amount: $json.value, direction: 'inflow', fee: 0 }) }}"
      },
      "id": "create_motion",
      "name": "Inflow ëª¨ì…˜ (ìˆ˜ìˆ˜ë£Œ 0%)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "channel": "#payments",
        "text": "ğŸ’° ê°€ìƒê³„ì¢Œ ì…ê¸ˆ ì™„ë£Œ!\nê¸ˆì•¡: â‚©{{ $json.value.toLocaleString() }}\nìˆ˜ìˆ˜ë£Œ: â‚©0 (ì ˆì•½: â‚©{{ Math.round($json.fee_saved).toLocaleString() }})",
        "otherOptions": {}
      },
      "id": "slack_notify",
      "name": "Slack ì•Œë¦¼ (ì„ íƒ)",
      "type": "n8n-nodes-base.slack",
      "position": [1250, 200],
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, node_id: $json.node_id, amount: $json.value, fee: 0, fee_saved: $json.fee_saved } }}"
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 300]
    }
  ],
  "connections": {
    "í† ìŠ¤ ì…ê¸ˆ Webhook": { "main": [[{ "node": "í† ìŠ¤ íŒŒì‹± (ìˆ˜ìˆ˜ë£Œ 0%)", "type": "main", "index": 0 }]] },
    "í† ìŠ¤ íŒŒì‹± (ìˆ˜ìˆ˜ë£Œ 0%)": { "main": [[{ "node": "ì™„ë£Œ ì²´í¬", "type": "main", "index": 0 }]] },
    "ì™„ë£Œ ì²´í¬": { 
      "main": [
        [{ "node": "Response", "type": "main", "index": 0 }],
        [{ "node": "ë…¸ë“œ ìƒì„±", "type": "main", "index": 0 }]
      ] 
    },
    "ë…¸ë“œ ìƒì„±": { "main": [[{ "node": "Inflow ëª¨ì…˜ (ìˆ˜ìˆ˜ë£Œ 0%)", "type": "main", "index": 0 }]] },
    "Inflow ëª¨ì…˜ (ìˆ˜ìˆ˜ë£Œ 0%)": { "main": [[{ "node": "Response", "type": "main", "index": 0 }]] }
  }
}
